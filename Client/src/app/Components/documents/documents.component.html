<div class="container">
  <div class="head">
    <div class="upload" [style.z-index]="34">
      <div class="upload-btn" (click)="showAddDocumentDialog = true">
        <i class="pi pi-plus"></i>
        <span>Upload</span>
      </div>
      <div
        class="upload-btn"
        style="background-color: var(--sibasiWhite); border: 1px solid #0f8bfd"
      >
        <i class="pi pi-filter-slash" style="color: #0f8bfd"></i>
        <span style="color: #0f8bfd">Clear</span>
      </div>
    </div>
    <div class="filter">
      <div
        class="upload-btn"
        style="background-color: var(--sibasiWhite); border: 1px solid #0f8bfd"
      >
        <i class="pi pi-star" style="color: #0f8bfd"></i>
        <span style="color: #0f8bfd">Favourites</span>
      </div>
      <div class="search">
        <i class="pi pi-search"></i>
        <input type="text" placeholder="Search" />
      </div>
      <div class="sort-view">
        <div
          class="list"
          [class.active]="currentView === 'list'"
          (click)="setView('list')"
        >
          <i class="pi pi-list"></i>
        </div>
        <div
          class="grid"
          [class.active]="currentView === 'grid'"
          (click)="setView('grid')"
        >
          <i class="pi pi-th-large"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="documents_sync">
    <div class="sync">
      <div
        class="sync-btn"
        [ngClass]="{ 'sync-active': dropboxSync }"
        (click)="toggleDropboxSync()"
      >
        <i
          class="{{
            dropboxSync ? 'pi pi-check-circle' : 'pi pi-times-circle'
          }}"
          [ngClass]="{ active: dropboxSync }"
        ></i>
        <span [ngClass]="{ active: dropboxSync }">Dropbox Sync</span>
      </div>
      <div
        class="sync-btn"
        [ngClass]="{ 'sync-active': driveSync }"
        (click)="toggleDriveSync()"
      >
        <i
          class="{{ driveSync ? 'pi pi-check-circle' : 'pi pi-times-circle' }}"
          [ngClass]="{ active: driveSync }"
        ></i>
        <span [ngClass]="{ active: driveSync }">Google Drive Sync</span>
      </div>
    </div>
  </div>
  <div class="table">
    <div class="card">
      <p-table
        [value]="dropboxSync ? dropBoxSynced : documents"
        *ngIf="currentView === 'list'"
        [tableStyle]="{ 'min-width': '50rem' }"
        styleClass="white-table"
        paginator="true"
        [rows]="7"
        [rowsPerPageOptions]="[10, 20, 30]"
      >
        <ng-template #header>
          <tr>
            <th>Name</th>
            <th>Source</th>
            <th>Size</th>
            <th>Type</th>
            <th></th>
          </tr>
        </ng-template>
        <ng-template #body let-document >
          <tr *ngIf="document.type !== 'Google-apps.folder'">
            <!--(click)="onDocumentClick(document.id)"-->
            <td class="file-image">
              <div style="display: flex; align-items: center;">
                <img
                *ngIf="
                  document.type === 'application/pdf' ||
                  document.type === 'PDF' ||
                  document.type === 'pdf' ||
                  document.path_lower?.endsWith('.pdf')
                "
                src="assets/pdf.png"
                class="pdf-icon"
                alt="PDF Icon"
              />
              <img
                *ngIf="
                  document.type === 'image/png' ||
                  document.type === 'image/jpeg' ||
                  document.type === 'image/jpg' ||
                  document.path_lower?.endsWith('.png') ||
                  document.path_lower?.endsWith('.jpg') ||
                  document.path_lower?.endsWith('.jpeg')
                "
                src="assets/photo.png"
                class="image-icon"
                alt="Image Icon"
              />
              <img
                *ngIf="
                  document.type ===
                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ||
                  document.type === 'Google Doc' ||
                  document.path_lower?.endsWith('.docx')
                "
                src="assets/doc.png"
                class="word-icon"
                alt="Word Icon"
              />
              <img 
                *ngIf="
                  document.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                  document.type === 'Google Sheet'
                "
                src="assets/sheets.png"
                class="sheet-icon"
                alt="Sheet Icon"
              />
              <img 
                *ngIf="
                  document.type ==='Word Document' 
                "
                src="assets/word.png"
                class="word-icon"

              />
              <img 
                *ngIf="
                  document.type ==='Google Slides'
                "
                src="assets/slides.png"
                class="slides-icon"
                
              />
              <img 
                *ngIf="
                  document.type ==='Video'
                  "
                src="assets/reel.png"
                class="video-icon"
              />
              {{ document.name }}
              </div>
            </td>
            <td>
              <ng-container *ngIf="document.tags?.length; else noTags">
                <span
                  *ngFor="let tag of document.tags; let i = index"
                  class="tag"
                >
                  <img
                    *ngIf="tag === 'drive'"
                    src="assets/google-drive.png"
                    class="google"
                    style="margin-right: 0.25rem"
                    title="Google drive"
                  />
                  <img
                    *ngIf="tag === 'local'"
                    src="assets/save.png"
                    class="desktop"
                    style="margin-right: 0.25rem"
                    title="Local"
                  />
                  <img
                    *ngIf="tag === 'dropbox'"
                    src="assets/dropbox.png"
                    class="cloud"
                    style="margin-right: 0.25rem"
                    title="Dropbox"
                  />

                  <span *ngIf="i < document.tags.length - 1">, </span>
                </span>
              </ng-container>
              <ng-template #noTags>
                <span class="tag">none</span>
              </ng-template>
            </td>
            <td>{{ document.size / (1024 * 1024) | number : "1.2-2" }} MB</td>

            <td>
              {{
                document.path_lower
                  ? document.path_lower.split(".").pop()?.toUpperCase()
                  : document.type?.includes("/")
                  ? document.type.split("/")[1]?.toUpperCase()
                  : document.tags?.includes("drive")
                  ? document.type
                  : document.type?.toUpperCase() || "Unknown"
              }}
            </td>
            <td>
              <i class="pi pi-ellipsis-v" (click)="op.toggle($event)">
                <p-popover
                  #op
                  styleClass="popover"
                  [style]="{ width: '12rem' }"
                >
                  <div class="popover-content">
                    <ul>
                      <li><i class="pi pi-eye"></i> view</li>
                      <li
                        *ngIf="
                          !document.tags?.includes('dropbox') &&
                          document.tags?.includes('local')
                        "
                        (click)="syncToDropbox(document)"
                      >
                        <i class="pi pi-cloud"></i> sync to Dropbox
                      </li>
                      <li
                        *ngIf="
                          !document.tags?.includes('local') &&
                          document.tags?.includes('dropbox')
                        "
                        (click)="downloadToLocal(document)"
                      >
                        <i class="pi pi-desktop" style="font-size: 0.8rem"></i>
                        Save from dropbox
                      </li>
                      <li 
                        *ngIf="
                          !document.tags?.includes('drive') &&
                          document.tags?.includes('local')
                        "
                        (click)="syncToGoogleDrive(document)"
                      >
                        <i class="pi pi-google" style="font-size: 0.8rem"></i>
                        Sync to Google Drive

                      </li>
                      <li
                        *ngIf="
                          !document.tags?.includes('local') &&
                          document.tags?.includes('drive')
                        "
                        (click)="downloadToLocalFromDrive(document.id)"
                      >
                        <i class="pi pi-desktop" style="font-size: 0.8rem"></i>
                        Save from Google Drive
                    </ul>
                  </div>
                </p-popover>
              </i>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
    <div class="grid-view" *ngIf="currentView === 'grid'">
      <div
        class="card"
        *ngFor="let document of dropboxSync ? dropBoxSynced : documents"
      >
        <!--  (click)="onDocumentClick(document.id)"  -->
        <div class="card-header">
          <i class="pi pi-file-pdf"></i> {{ document.name }}
        </div>
        <div class="card-body">
          <p>{{ document.size / (1024 * 1024) | number : "1.2-2" }} MB</p>
          <p>
            {{
              document.path_lower
                ? document.path_lower.split(".")[1]
                : document.type.split("/")[1]
            }}
          </p>
        </div>
        <div class="card-footer">
          <i class="pi pi-ellipsis-v"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<p-dialog
  header="New Document"
  [modal]="true"
  [(visible)]="showAddDocumentDialog"
  [style]="{ width: '25rem' }"
  styleClass="modal"
>
  <span class="p-text-secondary block mb-8">Upload new document</span>
  <div class="card">
    <p-toast />
    <p-fileupload
      name="demo[]"
      url="https://www.primefaces.org/cdn/api/upload.php"
      (onUpload)="onFileUpload($event)"
      [multiple]="true"
      accept="image/*, application/pdf"
      maxFileSize="1000000"
      mode="advanced"
      styleClass="fileDownload"
    >
      <ng-template #empty>
        <div>Drag and drop files to here to upload.</div>
      </ng-template>
    </p-fileupload>
  </div>
</p-dialog>
<app-loading
  *ngIf="isLoading"
></app-loading>




<ng-container *ngIf="isBrowser">
  <p-dialog
    header="Select File Sources"
    [modal]="true"
    [blockScroll]="true"
    [style]="{ width: '32rem' }"
    [(visible)]="showSelectDocSourceModal"
    [closable]="true"
    [styleClass]="'source-selection-modal'"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }"
    [maximizable]="false"
  >
    <div class="select-source-container">
      <div class="head">
        <span>Choose which sources to load documents from</span>
      </div>
      
      <div class="options">
        <div class="option" 
             [class.selected]="localSync"
             (click)="toggleSource('local')">
          <div class="option-icon">
            <img src="assets/save.png" alt="Database Files" />
          </div>
          <div class="option-content">
            <p class="option-title">Database Files</p>
            <p class="option-description">Your documents saved on Ebooard</p>
          </div>
          <div class="check-box">
            <p-checkbox 
              [(ngModel)]="localSync" 
              [binary]="true"
              (click)="$event.stopPropagation()">
            </p-checkbox>
          </div>
        </div>

        <div class="option" 
             [class.selected]="googleDriveSync"
             (click)="toggleSource('drive')">
          <div class="option-icon">
            <img src="assets/google-drive.png" alt="Google Drive" />
          </div>
          <div class="option-content">
            <p class="option-title">Google Drive</p>
            <p class="option-description">Google cloud Documents</p>
          </div>
          <div class="check-box">
            <p-checkbox 
              [(ngModel)]="googleDriveSync" 
              [binary]="true"
              (click)="$event.stopPropagation()">
            </p-checkbox>
          </div>
        </div>

        <div class="option" 
             [class.selected]="dropBoxSync"
             (click)="toggleSource('dropbox')">
          <div class="option-icon">
            <img src="assets/dropbox.png" alt="Dropbox" />
          </div>
          <div class="option-content">
            <p class="option-title">Dropbox</p>
            <p class="option-description">Dropbox Documents</p>
          </div>
          <div class="check-box">
            <p-checkbox 
              [(ngModel)]="dropBoxSync" 
              [binary]="true"
              (click)="$event.stopPropagation()">
            </p-checkbox>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div class="selection-count">
          <span>{{ getSelectionCount() }} source{{ getSelectionCount() !== 1 ? 's' : '' }} selected</span>
        </div>
        <div class="modal-actions">
          <button 
            pButton 
            label="Cancel" 
            class="p-button-secondary btn-secondary"
            (click)="cancelSelection()">
          </button>
          <button 
            pButton 
            label="Continue" 
            class="btn-primary"
            [disabled]="getSelectionCount() === 0"
            (click)="confirmSelection()">
          </button>
        </div>
      </div>
    </div>
  </p-dialog>
</ng-container>